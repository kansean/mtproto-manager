# MTProto Proxy Manager

Веб-панель для управления MTProto прокси-сервером Telegram. Позволяет запускать, останавливать и настраивать [mtg](https://github.com/9seconds/mtg) прокси через удобный веб-интерфейс с тёмной темой.

## Возможности

- **Управление прокси** — запуск, остановка, перезапуск mtg-контейнера из веб-интерфейса
- **Управление пользователями** — создание и удаление ключей доступа, включение/отключение пользователей
- **QR-коды** — генерация QR-кодов для быстрого подключения к прокси через Telegram
- **Ссылки** — автоматическая генерация `tg://` и `t.me/proxy` ссылок
- **Fake TLS** — маскировка трафика под обычный HTTPS (domain fronting)
- **Мониторинг** — статус прокси, количество подключений, логи контейнера в реальном времени
- **Безопасность** — аутентификация с хешированием PBKDF2, CSRF-защита, rate limiting
- **Docker** — полное развёртывание через Docker Compose (app + nginx + certbot)
- **SSL** — опциональный HTTPS с автоматическим получением сертификата Let's Encrypt

## Архитектура

```
┌─────────────────────────────────────────────────┐
│                   Сервер                        │
│                                                 │
│   :80/:443          :8080           :2443       │
│  ┌─────────┐    ┌───────────┐    ┌───────────┐ │
│  │  nginx   │───▶│  Flask    │    │ mtg-proxy │ │
│  │ (reverse │    │  app      │───▶│ (MTProto) │ │
│  │  proxy)  │    │ gunicorn  │    │           │ │
│  └─────────┘    └───────────┘    └───────────┘ │
│                       │                         │
│                 docker.sock                     │
│            (управление контейнерами)            │
└─────────────────────────────────────────────────┘
```

- **nginx** — обратный прокси, принимает HTTP/HTTPS запросы и перенаправляет в приложение
- **app** — Flask-приложение (gunicorn), управляет mtg-контейнерами через Docker API
- **mtg-proxy** — MTProto прокси, создаётся и управляется приложением динамически
- **certbot** — (опционально) автоматическое получение и обновление SSL-сертификатов

## Быстрая установка

Установка одной командой на чистый Linux-сервер (Ubuntu/Debian/CentOS/Fedora):

```bash
curl -sSL https://raw.githubusercontent.com/kansean/mtproto-manager/master/install.sh | bash
```

Скрипт автоматически:

1. Определит вашу ОС
2. Установит Docker и Docker Compose (если не установлены)
3. Скачает последнюю версию проекта
4. Спросит домен, порт прокси и нужен ли HTTPS
5. Сгенерирует `.env` файл с настройками
6. Получит SSL-сертификат (если выбран HTTPS)
7. Откроет нужные порты в файрволе (UFW/firewalld)
8. Запустит все сервисы через Docker Compose
9. Выведет учётные данные администратора и URL для доступа

## Ручная установка

```bash
git clone https://github.com/kansean/mtproto-manager.git /opt/mtproto
cd /opt/mtproto
docker compose up -d --build
```

После запуска учётные данные администратора будут в логах:

```bash
docker logs mtproto-app 2>&1 | grep -A3 "INITIAL ADMIN"
```

Веб-панель будет доступна на `http://<IP-сервера>:80`.

## Структура проекта

```
/opt/mtproto/
├── app/
│   ├── app.py              # Flask-приложение (маршруты, аутентификация)
│   ├── config.py           # Конфигурация (загрузка/сохранение JSON)
│   ├── services/
│   │   └── mtproto.py      # Работа с Docker API и mtg-контейнерами
│   ├── templates/          # HTML-шаблоны (Jinja2 + Tailwind CSS)
│   │   ├── base.html       # Базовый шаблон с навигацией
│   │   ├── dashboard.html  # Дашборд со статусом прокси
│   │   ├── users.html      # Управление пользователями
│   │   ├── settings.html   # Настройки сервера и прокси
│   │   ├── logs.html       # Просмотр логов контейнера
│   │   └── login.html      # Страница входа
│   └── static/css/         # Скомпилированные стили Tailwind
├── nginx/
│   ├── default.conf        # Конфиг nginx (HTTP)
│   └── ssl.conf.template   # Шаблон конфига nginx (HTTPS)
├── data/                   # Данные приложения (не в git)
│   └── config.json         # Конфигурация и список пользователей
├── docker-compose.yml      # Описание сервисов (app + nginx + certbot)
├── Dockerfile              # Сборка образа Flask-приложения
├── requirements.txt        # Python-зависимости
├── wsgi.py                 # Точка входа WSGI (gunicorn)
├── install.sh              # Скрипт установки
└── update.sh               # Скрипт обновления
```

## Конфигурация

### Переменные окружения

| Переменная | Описание | По умолчанию |
|---|---|---|
| `MTPROTO_DATA_DIR` | Путь к каталогу данных | `/opt/mtproto/data` |
| `HTTP_PORT` | HTTP-порт nginx | `80` |
| `HTTPS_PORT` | HTTPS-порт nginx | `443` |

### Файл конфигурации (`data/config.json`)

Создаётся автоматически при первом запуске. Содержит:

- **admin_username / admin_password_hash** — учётные данные администратора
- **server_domain / server_ip** — адрес сервера для генерации ссылок
- **proxy_port** — порт MTProto прокси (по умолчанию `2443`)
- **proxy_image** — Docker-образ mtg (по умолчанию `nineseconds/mtg:2`)
- **users** — список пользователей с секретными ключами
- **fake_tls_domain** — домен для маскировки TLS-трафика
- **stats_enabled** — включить сбор статистики (порт 3129)

Все настройки можно изменить через веб-интерфейс в разделе **Settings**.

## Управление

### Запуск / остановка сервисов

```bash
cd /opt/mtproto

# Запустить все сервисы
docker compose up -d

# Остановить все сервисы
docker compose down

# Посмотреть логи
docker compose logs -f

# Пересобрать после изменений
docker compose up -d --build
```

### Запуск с HTTPS

```bash
# Запуск с профилем ssl (включает certbot)
docker compose --profile ssl up -d
```

### Обновление

```bash
bash /opt/mtproto/update.sh
```

Скрипт обновления:

1. Создаёт резервную копию текущих файлов в `/tmp/`
2. Скачивает последнюю версию с GitHub
3. Останавливает контейнеры
4. Обновляет файлы приложения (каталог `data/` и конфигурация nginx сохраняются)
5. Пересобирает и запускает контейнеры

## Веб-интерфейс

### Страницы

- **Dashboard** — статус прокси, порт, количество пользователей, управление запуском
- **Users** — список пользователей с ключами, ссылками `t.me/proxy`, QR-кодами
- **Settings** — домен, IP, порт прокси, Fake TLS домен, proxy tag, смена пароля
- **Logs** — просмотр логов mtg-контейнера с автообновлением

### Первый вход

При первом запуске генерируются случайные учётные данные администратора. Логин и пароль выводятся в логах контейнера. После первого входа начальный пароль удаляется из конфигурации. Рекомендуется сразу сменить пароль в разделе **Settings**.

## Безопасность

- Пароли хешируются алгоритмом **PBKDF2-HMAC-SHA256** (100 000 итераций) с уникальной солью
- **CSRF-токены** на всех POST-запросах
- **Rate limiting** на странице входа — 5 попыток за 5 минут
- Сессии с **HttpOnly** и **SameSite=Lax** куками, время жизни 12 часов
- Атомарная запись конфигурации (через временный файл + `os.replace`)

## Требования

- Linux (Ubuntu 20.04+, Debian 11+, CentOS 8+, Fedora 36+)
- Docker 20.10+
- Docker Compose V2 (или docker-compose standalone)
- 512 МБ RAM минимум
- Открытые порты: 80 (HTTP), 443 (HTTPS, опционально), 2443 (MTProto прокси)

## Технологии

- **Python 3.11** + **Flask 3.0** + **Gunicorn**
- **Docker SDK for Python** — управление контейнерами
- **mtg v2** — MTProto прокси-сервер
- **nginx** — обратный прокси
- **Tailwind CSS** — стилизация интерфейса
- **Let's Encrypt / Certbot** — SSL-сертификаты
