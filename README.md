# MTProto Proxy Manager

Веб-панель для управления MTProto прокси-сервером Telegram. Позволяет запускать, останавливать и настраивать [mtg](https://github.com/9seconds/mtg) прокси через удобный веб-интерфейс с тёмной темой.

## Возможности

- **Управление прокси** — запуск, остановка, перезапуск mtg-контейнера из веб-интерфейса
- **Управление пользователями** — создание и удаление ключей доступа, включение/отключение пользователей
- **QR-коды** — генерация QR-кодов для быстрого подключения к прокси через Telegram
- **Ссылки** — автоматическая генерация `tg://` и `t.me/proxy` ссылок
- **Fake TLS** — маскировка трафика под обычный HTTPS (domain fronting)
- **Мониторинг** — статус прокси, количество подключений, логи контейнера в реальном времени
- **Безопасность** — аутентификация с хешированием PBKDF2, CSRF-защита, rate limiting
- **Docker** — полное развёртывание через Docker Compose (app + nginx + certbot)
- **SSL** — опциональный HTTPS с автоматическим получением сертификата Let's Encrypt

## Архитектура

```
┌─────────────────────────────────────────────────┐
│                   Сервер                        │
│                                                 │
│   :80/:443          :8080           :2443       │
│  ┌─────────┐    ┌───────────┐    ┌───────────┐ │
│  │  nginx   │───▶│  Flask    │    │ mtg-proxy │ │
│  │ (reverse │    │  app      │───▶│ (MTProto) │ │
│  │  proxy)  │    │ gunicorn  │    │           │ │
│  └─────────┘    └───────────┘    └───────────┘ │
│                       │                         │
│                 docker.sock                     │
│            (управление контейнерами)            │
└─────────────────────────────────────────────────┘
```

- **nginx** — обратный прокси, принимает HTTP/HTTPS запросы и перенаправляет в приложение
- **app** — Flask-приложение (gunicorn), управляет mtg-контейнерами через Docker API
- **mtg-proxy** — MTProto прокси, создаётся и управляется приложением динамически
- **certbot** — (опционально) автоматическое получение и обновление SSL-сертификатов

## Быстрая установка

Установка одной командой на чистый Linux-сервер (Ubuntu/Debian/CentOS/Fedora):

```bash
curl -sSL https://raw.githubusercontent.com/kansean/mtproto-manager/master/install.sh | bash
```

> Скрипт необходимо запускать от **root** (`sudo -i` или `sudo bash`).

Скрипт автоматически:

1. Определит ОС и тип виртуализации (KVM, LXC, OpenVZ, bare metal)
2. Установит базовые пакеты (curl, ca-certificates, tar)
3. Установит Docker и Docker Compose (если не установлены)
4. Настроит Docker для LXC-окружений (отключение AppArmor)
5. Проверит работоспособность Docker (`hello-world`)
6. Скачает последнюю версию проекта
7. Спросит домен, порт прокси и нужен ли HTTPS
8. Получит SSL-сертификат (если выбран HTTPS)
9. Откроет нужные порты в файрволе (UFW/firewalld)
10. Запустит все сервисы через Docker Compose
11. Выведет учётные данные администратора и URL для доступа

## Ручная установка

```bash
git clone https://github.com/kansean/mtproto-manager.git /opt/mtproto
cd /opt/mtproto
docker compose up -d --build
```

После запуска учётные данные администратора будут в логах:

```bash
docker logs mtproto-app 2>&1 | grep -A3 "INITIAL ADMIN"
```

Или в файле конфигурации (до первого входа):

```bash
grep -E "admin_username|_initial_password" /opt/mtproto/data/config.json
```

Веб-панель будет доступна на `http://<IP-сервера>:80`.

## Структура проекта

```
/opt/mtproto/
├── app/
│   ├── app.py              # Flask-приложение (маршруты, аутентификация)
│   ├── config.py           # Конфигурация (загрузка/сохранение JSON)
│   ├── services/
│   │   └── mtproto.py      # Работа с Docker API и mtg-контейнерами
│   ├── templates/          # HTML-шаблоны (Jinja2 + Tailwind CSS)
│   │   ├── base.html       # Базовый шаблон с навигацией
│   │   ├── dashboard.html  # Дашборд со статусом прокси
│   │   ├── users.html      # Управление пользователями
│   │   ├── settings.html   # Настройки сервера и прокси
│   │   ├── logs.html       # Просмотр логов контейнера
│   │   └── login.html      # Страница входа
│   └── static/css/         # Скомпилированные стили Tailwind
├── nginx/
│   ├── default.conf        # Конфиг nginx (HTTP)
│   └── ssl.conf.template   # Шаблон конфига nginx (HTTPS)
├── data/                   # Данные приложения (не в git)
│   └── config.json         # Конфигурация и список пользователей
├── docker-compose.yml      # Описание сервисов (app + nginx + certbot)
├── Dockerfile              # Сборка образа Flask-приложения
├── requirements.txt        # Python-зависимости
├── wsgi.py                 # Точка входа WSGI (gunicorn)
├── install.sh              # Скрипт установки
└── update.sh               # Скрипт обновления
```

## Конфигурация

### Переменные окружения

| Переменная | Описание | По умолчанию |
|---|---|---|
| `MTPROTO_DATA_DIR` | Путь к каталогу данных | `/opt/mtproto/data` |
| `HTTP_PORT` | HTTP-порт nginx | `80` |
| `HTTPS_PORT` | HTTPS-порт nginx | `443` |

### Файл конфигурации (`data/config.json`)

Создаётся автоматически при первом запуске. Содержит:

- **admin_username / admin_password_hash** — учётные данные администратора
- **server_domain / server_ip** — адрес сервера для генерации ссылок
- **proxy_port** — порт MTProto прокси (по умолчанию `2443`)
- **proxy_image** — Docker-образ mtg (по умолчанию `nineseconds/mtg:2`)
- **users** — список пользователей с секретными ключами
- **fake_tls_domain** — домен для маскировки TLS-трафика
- **stats_enabled** — включить сбор статистики (порт 3129)

Все настройки можно изменить через веб-интерфейс в разделе **Settings**.

## Управление

### Запуск / остановка сервисов

```bash
cd /opt/mtproto

# Запустить все сервисы
docker compose up -d

# Остановить все сервисы
docker compose down

# Посмотреть логи
docker compose logs -f

# Пересобрать после изменений
docker compose up -d --build
```

### Запуск с HTTPS

```bash
# Запуск с профилем ssl (включает certbot)
docker compose --profile ssl up -d
```

### Обновление

```bash
bash /opt/mtproto/update.sh
```

Скрипт обновления:

1. Создаёт резервную копию текущих файлов в `/tmp/`
2. Скачивает последнюю версию с GitHub
3. Останавливает контейнеры
4. Обновляет файлы приложения (каталог `data/` и конфигурация nginx сохраняются)
5. Пересобирает и запускает контейнеры

### Полное удаление

```bash
# Остановить и удалить все контейнеры, сети и образы проекта
cd /opt/mtproto
docker compose --profile ssl down --rmi all --volumes 2>/dev/null; docker compose down --rmi all --volumes

# Удалить mtg-proxy контейнер (создаётся приложением динамически)
docker rm -f mtg-proxy 2>/dev/null

# Удалить файлы проекта
rm -rf /opt/mtproto

# Удалить неиспользуемые Docker-образы (опционально)
docker image prune -f
```

> Docker и Docker Compose останутся в системе. Для их удаления: `apt-get remove -y docker-ce docker-ce-cli containerd.io docker-compose-plugin` (Ubuntu/Debian) или `yum remove -y docker-ce docker-ce-cli containerd.io docker-compose-plugin` (CentOS/Fedora).

## Веб-интерфейс

### Страницы

- **Dashboard** — статус прокси, порт, количество пользователей, управление запуском
- **Users** — список пользователей с ключами, ссылками `t.me/proxy`, QR-кодами
- **Settings** — домен, IP, порт прокси, Fake TLS домен, proxy tag, смена пароля
- **Logs** — просмотр логов mtg-контейнера с автообновлением

### Логи (страница Logs)

Страница Logs отображает вывод mtg-proxy контейнера в реальном времени. mtg v2 по умолчанию работает в **тихом режиме** — это нормальное поведение.

**Что логируется:**

| Событие | Когда появляется |
|---|---|
| Запуск прокси | При старте контейнера (адрес и порт привязки) |
| Ошибки соединений | При сбоях подключения клиентов |
| Ошибки конфигурации | При неверных параметрах запуска |
| Остановка прокси | При остановке контейнера |

**Что НЕ логируется** (по умолчанию):
- Успешные подключения клиентов
- Трафик и объём переданных данных
- IP-адреса пользователей

> Пустые логи после запуска прокси — **нормально**. Это означает, что прокси работает штатно. Записи появятся при возникновении ошибок.

### Первый вход

При первом запуске генерируются случайные учётные данные администратора. Логин и пароль выводятся при установке и сохраняются в `data/config.json` (поле `_initial_password`). После первого входа начальный пароль удаляется из конфигурации. Рекомендуется сразу сменить пароль в разделе **Settings**.

## Безопасность

- Пароли хешируются алгоритмом **PBKDF2-HMAC-SHA256** (100 000 итераций) с уникальной солью
- **CSRF-токены** на всех POST-запросах
- **Rate limiting** на странице входа — 5 попыток за 5 минут
- Сессии с **HttpOnly** и **SameSite=Lax** куками, время жизни 12 часов
- Атомарная запись конфигурации (через временный файл + `os.replace`)

## Технические требования к серверу

### Аппаратные требования

| Параметр | Минимум | Рекомендуется |
|---|---|---|
| **CPU** | 1 vCPU | 2 vCPU |
| **RAM** | 512 МБ | 1 ГБ |
| **Диск** | 2 ГБ свободного места | 5 ГБ |
| **Архитектура** | x86_64 (amd64) | x86_64 (amd64) |

> Указаны требования для самого менеджера и прокси. При большом количестве одновременных подключений (100+) рекомендуется увеличить RAM до 2 ГБ.

### Операционная система

- **Ubuntu** 20.04+
- **Debian** 11+
- **CentOS** 8+
- **Fedora** 36+
- Другие дистрибутивы Linux с поддержкой Docker

> Windows и macOS не поддерживаются для production-развёртывания.

### Виртуализация

| Платформа | Поддержка | Примечания |
|---|---|---|
| **Bare metal** | Полная | Без ограничений |
| **KVM / QEMU** | Полная | Рекомендуемый вариант для VPS |
| **Proxmox VM** | Полная | Без ограничений |
| **Proxmox CT (LXC)** | С настройкой | Требуется привилегированный CT + Nesting |
| **OpenVZ** | Не рекомендуется | Ограниченная поддержка Docker |

> Для Proxmox CT: создайте **привилегированный** контейнер с включённой опцией **Nesting** (Options → Features).

### Программные зависимости

- **Docker** 20.10+ — установится автоматически через `install.sh`
- **Docker Compose** V2 (плагин) или docker-compose standalone — установится автоматически
- **curl** — для скачивания скрипта установки
- **root-доступ** (sudo) — требуется для установки Docker и управления портами

### Сетевые требования

| Порт | Протокол | Назначение | Обязательный |
|---|---|---|---|
| 80 | TCP | HTTP (веб-панель, ACME challenge) | Да |
| 443 | TCP | HTTPS (веб-панель с SSL) | Нет (опционально) |
| 2443 | TCP | MTProto прокси (настраиваемый) | Да |

- Статический IP-адрес или доменное имя
- Для HTTPS необходим домен, направленный A-записью на IP сервера
- Порт MTProto прокси (по умолчанию 2443) должен быть доступен извне для подключения клиентов Telegram
- Провайдер не должен блокировать указанные порты

## Технологии

- **Python 3.11** + **Flask 3.0** + **Gunicorn**
- **Docker SDK for Python** — управление контейнерами
- **mtg v2** — MTProto прокси-сервер
- **nginx** — обратный прокси
- **Tailwind CSS** — стилизация интерфейса
- **Let's Encrypt / Certbot** — SSL-сертификаты
