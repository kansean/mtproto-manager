# MTProto Proxy Manager

Веб-панель для управления MTProto прокси-сервером Telegram. Позволяет запускать, останавливать и настраивать [mtg](https://github.com/9seconds/mtg) прокси через удобный веб-интерфейс с тёмной темой.

## Возможности

- **Многопользовательский режим** — каждый пользователь получает отдельный mtg-контейнер на своём порту (mtg v2 поддерживает 1 секрет на инстанс)
- **Управление прокси** — запуск, остановка, перезапуск всех контейнеров из веб-интерфейса
- **Управление пользователями** — создание и удаление ключей доступа, включение/отключение пользователей, автоматическое назначение портов
- **Per-user настройки** — индивидуальная смена SNI-домена, лимита трафика и скорости throttle для каждого пользователя
- **Port 443 SNI routing** — все пользователи могут работать через единый порт 443, nginx маршрутизирует трафик по SNI-домену (каждому пользователю назначается уникальный домен из пула)
- **QR-коды** — генерация QR-кодов для быстрого подключения к прокси через Telegram
- **Ссылки** — автоматическая генерация `tg://` и `t.me/proxy` ссылок с правильным портом для каждого пользователя
- **Fake TLS** — маскировка трафика под обычный HTTPS (domain fronting)
- **Мониторинг** — агрегированный статус прокси ("Running 2/3"), логи со всех контейнеров
- **Мониторинг трафика** — агрегированное и **per-user** отслеживание входящего/исходящего трафика со всех контейнеров через Docker API
- **Лимиты трафика** — глобальный и **per-user** лимиты (ГБ) со снижением скорости (`tc`) при превышении; per-user лимит имеет приоритет над глобальным
- **Безопасность** — аутентификация с хешированием PBKDF2, CSRF-защита, rate limiting
- **Docker** — полное развёртывание через Docker Compose (app + nginx + certbot)
- **SSL** — опциональный HTTPS с автоматическим получением сертификата Let's Encrypt
- **Миграция** — существующие конфиги без полей `port` автоматически мигрируют при загрузке

## Архитектура

```
Стандартный режим (каждый пользователь на своём порту):

┌──────────────────────────────────────────────────────────┐
│                        Сервер                            │
│                                                          │
│   :80/:443          :8080           :2443  :2444  :2445  │
│  ┌─────────┐    ┌───────────┐    ┌──────┐┌──────┐┌────┐ │
│  │  nginx   │───▶│  Flask    │    │ mtg  ││ mtg  ││mtg │ │
│  │ (reverse │    │  app      │───▶│proxy ││proxy ││prox│ │
│  │  proxy)  │    │ gunicorn  │    │-2443 ││-2444 ││-244│ │
│  └─────────┘    └───────────┘    └──────┘└──────┘└────┘ │
│                       │             User1   User2  User3 │
│                 docker.sock                              │
│            (управление контейнерами)                     │
└──────────────────────────────────────────────────────────┘

Port 443 SNI mode (все пользователи через единый порт 443):

┌──────────────────────────────────────────────────────────┐
│                        Сервер                            │
│                                                          │
│   :443 (stream)     :8443           :2443  :2444  :2445  │
│  ┌─────────┐    ┌───────────┐    ┌──────┐┌──────┐┌────┐ │
│  │  nginx   │───▶│  Flask    │    │ mtg  ││ mtg  ││mtg │ │
│  │  stream  │    │  (HTTPS)  │    │proxy ││proxy ││prox│ │
│  │  SNI map │──────────────────▶│-2443 ││-2444 ││-244│ │
│  └─────────┘    └───────────┘    └──────┘└──────┘└────┘ │
│   SNI domain                       apple   google  cloud │
│   → backend                        .com    .com    flare │
└──────────────────────────────────────────────────────────┘
```

- **nginx** — обратный прокси; в стандартном режиме перенаправляет HTTP/HTTPS в приложение; в SNI-режиме также маршрутизирует порт 443 по SNI-домену к нужному mtg-контейнеру
- **app** — Flask-приложение (gunicorn), управляет mtg-контейнерами через Docker API
- **mtg-proxy-{port}** — отдельный MTProto прокси-контейнер для каждого пользователя, создаётся и управляется приложением динамически
- **certbot** — (опционально) автоматическое получение и обновление SSL-сертификатов

### Почему отдельный контейнер на пользователя?

mtg v2 поддерживает только **один секрет на инстанс**. При попытке подключить нескольких пользователей к одному контейнеру, работает только первый — остальные видят "connecting" в Telegram. Решение: каждый пользователь получает свой контейнер на уникальном порту.

## Быстрая установка

Установка одной командой на чистый Linux-сервер (Ubuntu/Debian/CentOS/Fedora):

```bash
curl -sSL https://raw.githubusercontent.com/kansean/mtproto-manager/master/install.sh | bash
```

> Скрипт необходимо запускать от **root** (`sudo -i` или `sudo bash`).

Скрипт автоматически:

1. Определит ОС и тип виртуализации (KVM, LXC, OpenVZ, bare metal)
2. Установит базовые пакеты (curl, ca-certificates, tar)
3. Установит Docker и Docker Compose (если не установлены)
4. Настроит Docker для LXC-окружений (отключение AppArmor)
5. Проверит работоспособность Docker (`hello-world`)
6. Скачает последнюю версию проекта
7. Соберёт кастомный Docker-образ `mtg-custom` (mtg + iproute2 для контроля трафика)
8. Спросит домен, порт прокси и нужен ли HTTPS
9. Получит SSL-сертификат (если выбран HTTPS)
10. Откроет диапазон портов в файрволе (базовый порт + 9 портов для пользователей)
11. Запустит все сервисы через Docker Compose
12. Выведет учётные данные администратора и URL для доступа

## Ручная установка

```bash
git clone https://github.com/kansean/mtproto-manager.git /opt/mtproto
cd /opt/mtproto
docker compose up -d --build
```

После запуска учётные данные администратора будут в логах:

```bash
docker logs mtproto-app 2>&1 | grep -A3 "INITIAL ADMIN"
```

Или в файле конфигурации (до первого входа):

```bash
grep -E "admin_username|_initial_password" /opt/mtproto/data/config.json
```

Веб-панель будет доступна на `http://<IP-сервера>:80`.

## Структура проекта

```
/opt/mtproto/
├── app/
│   ├── app.py              # Flask-приложение (маршруты, аутентификация)
│   ├── config.py           # Конфигурация, миграция портов пользователей
│   ├── services/
│   │   ├── mtproto.py      # Работа с Docker API, один контейнер на пользователя
│   │   ├── nginx_config.py # Генерация nginx конфигов (SNI routing, http/stream)
│   │   └── traffic.py      # Мониторинг трафика: per-user лимиты и throttling
│   ├── templates/          # HTML-шаблоны (Jinja2 + Tailwind CSS)
│   │   ├── base.html       # Базовый шаблон с навигацией
│   │   ├── dashboard.html  # Дашборд со статусом прокси (Running X/Y)
│   │   ├── users.html      # Управление пользователями (с портами)
│   │   ├── settings.html   # Настройки сервера и прокси
│   │   ├── logs.html       # Просмотр логов контейнеров
│   │   └── login.html      # Страница входа
│   └── static/css/         # Скомпилированные стили Tailwind
├── nginx/
│   ├── default.conf        # Конфиг nginx (HTTP)
│   └── ssl.conf.template   # Шаблон конфига nginx (HTTPS)
├── data/                   # Данные приложения (не в git)
│   ├── config.json         # Конфигурация и список пользователей (с портами)
│   ├── traffic.json        # Накопленные счётчики трафика (агрегированные + per-user)
│   └── nginx/              # Сгенерированные nginx конфиги (conf.d/, stream.d/)
├── docker-compose.yml      # Описание сервисов (app + nginx + certbot)
├── Dockerfile              # Сборка образа Flask-приложения
├── Dockerfile.mtg          # Кастомный образ mtg с iproute2 (для tc)
├── requirements.txt        # Python-зависимости
├── wsgi.py                 # Точка входа WSGI (gunicorn)
├── install.sh              # Скрипт установки
└── update.sh               # Скрипт обновления
```

## Конфигурация

### Переменные окружения

| Переменная | Описание | По умолчанию |
|---|---|---|
| `MTPROTO_DATA_DIR` | Путь к каталогу данных | `/opt/mtproto/data` |
| `HTTP_PORT` | HTTP-порт nginx | `80` |
| `HTTPS_PORT` | HTTPS-порт nginx | `443` |

### Файл конфигурации (`data/config.json`)

Создаётся автоматически при первом запуске. Содержит:

- **admin_username / admin_password_hash** — учётные данные администратора
- **server_domain / server_ip** — адрес сервера для генерации ссылок
- **proxy_port** — базовый порт MTProto прокси (по умолчанию `2443`). Первый пользователь получает этот порт, каждый следующий — на 1 больше.
- **proxy_image** — Docker-образ mtg (по умолчанию `mtg-custom`)
- **users** — список пользователей с секретными ключами и назначенными портами
- **fake_tls_domain** — домен для маскировки TLS-трафика
- **stats_enabled** — включить сбор статистики (порт 3129)
- **traffic_limit_gb** — глобальный лимит трафика в ГБ (`0` = без лимита)
- **throttle_speed_mbps** — скорость при превышении лимита (Мбит/с, по умолчанию `1`)
- **port_443_mode** — режим SNI-маршрутизации через порт 443 (требуется SSL-сертификат)

Все настройки можно изменить через веб-интерфейс в разделе **Settings**.

### Per-user настройки

Каждый пользователь может иметь индивидуальные параметры, доступные через кнопку настроек (шестерёнка) на странице Users:

- **SNI-домен** — в режиме Port 443 можно сменить домен (например, с `www.google.com` на `www.apple.com`). Смена домена перегенерирует секрет и перезапустит прокси — нужно будет отправить новую ссылку.
- **Traffic Limit (GB)** — индивидуальный лимит трафика. `0` = использовать глобальную настройку.
- **Throttle Speed (Mbps)** — индивидуальная скорость при превышении лимита. `0` = использовать глобальную настройку.

Пример конфигурации пользователя с per-user настройками:

```json
{
  "name": "Phone",
  "secret": "ee...",
  "port": 2443,
  "enabled": true,
  "fake_tls_domain": "www.apple.com",
  "traffic_limit_gb": 50,
  "throttle_speed_mbps": 2
}
```

### Порты пользователей

Каждый пользователь получает уникальный порт, который сохраняется в `config.json`:

```json
{
  "proxy_port": 2443,
  "users": [
    {"name": "Phone", "secret": "ee...", "port": 2443, "enabled": true},
    {"name": "Friend", "secret": "ee...", "port": 2444, "enabled": true}
  ]
}
```

- Порт назначается при создании пользователя и **не меняется** при удалении других пользователей
- Порты **стабильны** — удаление пользователя не сдвигает порты остальных
- При миграции старых конфигов (без `port`) порты назначаются автоматически: `base_port + i`

## Управление

### Запуск / остановка сервисов

```bash
cd /opt/mtproto

# Запустить все сервисы
docker compose up -d

# Остановить все сервисы
docker compose down

# Посмотреть логи
docker compose logs -f

# Пересобрать после изменений
docker compose up -d --build
```

### Запуск с HTTPS

```bash
# Запуск с профилем ssl (включает certbot)
docker compose --profile ssl up -d
```

### Обновление

```bash
bash /opt/mtproto/update.sh
```

Скрипт обновления:

1. Создаёт резервную копию текущих файлов в `/tmp/`
2. Скачивает последнюю версию с GitHub
3. Останавливает контейнеры
4. Обновляет файлы приложения (каталог `data/` и конфигурация nginx сохраняются)
5. Пересобирает и запускает контейнеры

### Полное удаление

```bash
# Остановить и удалить все контейнеры, сети и образы проекта
cd /opt/mtproto
docker compose --profile ssl down --rmi all --volumes 2>/dev/null; docker compose down --rmi all --volumes

# Удалить все mtg-proxy контейнеры (по одному на пользователя)
docker ps -a --filter "name=mtg-proxy-" -q | xargs -r docker rm -f

# Удалить legacy контейнер (если остался от старой версии)
docker rm -f mtg-proxy 2>/dev/null

# Удалить кастомный образ
docker rmi mtg-custom 2>/dev/null

# Удалить файлы проекта
rm -rf /opt/mtproto

# Удалить неиспользуемые Docker-образы (опционально)
docker image prune -f
```

> Docker и Docker Compose останутся в системе. Для их удаления: `apt-get remove -y docker-ce docker-ce-cli containerd.io docker-compose-plugin` (Ubuntu/Debian) или `yum remove -y docker-ce docker-ce-cli containerd.io docker-compose-plugin` (CentOS/Fedora).

## Веб-интерфейс

### Страницы

- **Dashboard** — агрегированный статус прокси ("Running 2/3"), диапазон портов, количество пользователей, трафик (агрегированный + таблица по пользователям с лимитами и статусом throttle), управление запуском
- **Users** — список пользователей с ключами, портами, трафиком, ссылками `t.me/proxy`, QR-кодами, per-user настройки (SNI-домен, лимит трафика, скорость throttle)
- **Settings** — домен, IP, базовый порт прокси, Fake TLS домен, proxy tag, глобальные лимиты трафика, режим Port 443 SNI, смена пароля
- **Logs** — агрегированные логи со всех mtg-контейнеров с префиксом `[mtg-proxy-{port}]`

### Логи (страница Logs)

Страница Logs отображает объединённые логи всех mtg-proxy контейнеров. Каждая строка имеет префикс с именем контейнера: `[mtg-proxy-2443]`, `[mtg-proxy-2444]` и т.д. mtg v2 по умолчанию работает в **тихом режиме** — это нормальное поведение.

**Что логируется:**

| Событие | Когда появляется |
|---|---|
| Запуск прокси | При старте контейнера (адрес и порт привязки) |
| Ошибки соединений | При сбоях подключения клиентов |
| Ошибки конфигурации | При неверных параметрах запуска |
| Остановка прокси | При остановке контейнера |

**Что НЕ логируется** (по умолчанию):
- Успешные подключения клиентов
- Трафик и объём переданных данных
- IP-адреса пользователей

> Пустые логи после запуска прокси — **нормально**. Это означает, что прокси работает штатно. Записи появятся при возникновении ошибок.

### Мониторинг трафика

Трафик отслеживается через Docker API (`container.stats()`) со **всех** запущенных mtg-proxy контейнеров. Фоновый поток опрашивает Docker каждые 10 секунд и накапливает дельту в `data/traffic.json`, отслеживая счётчики каждого контейнера отдельно в поле `last_per_container`.

**Особенности:**
- **Агрегация** — трафик со всех контейнеров суммируется в единые счётчики `rx_bytes` / `tx_bytes`, а также отслеживается **per-user** (порт контейнера → пользователь)
- **Персистентное хранение** — счётчики сохраняются на диск и не сбрасываются при перезапуске
- **Дельта-логика** — если счётчик Docker стал меньше предыдущего (контейнер перезапустился), базовая точка сбрасывается в 0
- **Per-user лимиты** — каждый пользователь может иметь индивидуальный лимит трафика и скорость throttle; при превышении ограничивается **только этот пользователь** (его контейнер), а не все
- **Приоритет лимитов** — per-user лимит > глобальный лимит; значение `0` означает «использовать глобальную настройку»
- **Throttling** — используется `tc qdisc tbf` внутри каждого mtg-контейнера (требуется кастомный образ `mtg-custom` с `iproute2`)
- **Сброс счётчиков** — кнопка "Reset Traffic Counter" в Settings обнуляет счётчики и снимает throttle со всех контейнеров

> Для работы throttling необходим кастомный Docker-образ `mtg-custom`, который собирается автоматически при установке из `Dockerfile.mtg`.

### Port 443 SNI routing

Режим Port 443 позволяет всем пользователям подключаться через единый порт 443, что полезно когда провайдер блокирует нестандартные порты. Включается в Settings (требуется SSL-сертификат).

**Как это работает:**
1. nginx `stream` блок слушает порт 443 и читает SNI (Server Name Indication) из TLS ClientHello
2. По SNI-домену nginx определяет, куда направить соединение:
   - Домен сервера (например `proxy.example.com`) → веб-панель (HTTPS на порту 8443)
   - Домен из пула (например `www.apple.com`) → соответствующий mtg-контейнер
3. Каждому пользователю назначается уникальный домен из пула (20 доменов: cloudflare, google, apple, microsoft и др.)

**Технические детали:**
- Используется `map` + переменная `proxy_pass $backend` (не `upstream` блоки) — это позволяет nginx запускаться даже если контейнер ещё не создан
- DNS-резолвинг через Docker DNS (`resolver 127.0.0.11`) происходит в runtime
- Таймаут `proxy_timeout 24h` для долгоживущих MTProto-соединений на мобильных устройствах
- Смена SNI-домена доступна через per-user настройки (кнопка шестерёнки на странице Users)

### Первый вход

При первом запуске генерируются случайные учётные данные администратора. Логин и пароль выводятся при установке и сохраняются в `data/config.json` (поле `_initial_password`). После первого входа начальный пароль удаляется из конфигурации. Рекомендуется сразу сменить пароль в разделе **Settings**.

## Безопасность

- Пароли хешируются алгоритмом **PBKDF2-HMAC-SHA256** (100 000 итераций) с уникальной солью
- **CSRF-токены** на всех POST-запросах
- **Rate limiting** на странице входа — 5 попыток за 5 минут
- Сессии с **HttpOnly** и **SameSite=Lax** куками, время жизни 12 часов
- Атомарная запись конфигурации (через временный файл + `os.replace`)

## Технические требования к серверу

### Аппаратные требования

| Параметр | Минимум | Рекомендуется |
|---|---|---|
| **CPU** | 1 vCPU | 2 vCPU |
| **RAM** | 512 МБ | 1 ГБ |
| **Диск** | 2 ГБ свободного места | 5 ГБ |
| **Архитектура** | x86_64 (amd64) | x86_64 (amd64) |

> Указаны требования для самого менеджера и прокси. Каждый пользователь добавляет ~30 МБ RAM на отдельный mtg-контейнер. При большом количестве пользователей или подключений рекомендуется увеличить RAM.

### Операционная система

- **Ubuntu** 20.04+
- **Debian** 11+
- **CentOS** 8+
- **Fedora** 36+
- Другие дистрибутивы Linux с поддержкой Docker

> Windows и macOS не поддерживаются для production-развёртывания.

### Виртуализация

| Платформа | Поддержка | Примечания |
|---|---|---|
| **Bare metal** | Полная | Без ограничений |
| **KVM / QEMU** | Полная | Рекомендуемый вариант для VPS |
| **Proxmox VM** | Полная | Без ограничений |
| **Proxmox CT (LXC)** | С настройкой | Требуется привилегированный CT + Nesting |
| **OpenVZ** | Не рекомендуется | Ограниченная поддержка Docker |

> Для Proxmox CT: создайте **привилегированный** контейнер с включённой опцией **Nesting** (Options → Features).

### Программные зависимости

- **Docker** 20.10+ — установится автоматически через `install.sh`
- **Docker Compose** V2 (плагин) или docker-compose standalone — установится автоматически
- **curl** — для скачивания скрипта установки
- **root-доступ** (sudo) — требуется для установки Docker и управления портами

### Сетевые требования

| Порт | Протокол | Назначение | Обязательный |
|---|---|---|---|
| 80 | TCP | HTTP (веб-панель, ACME challenge) | Да |
| 443 | TCP | HTTPS (веб-панель с SSL) / SNI routing (Port 443 mode) | Нет (опционально) |
| 2443-2452 | TCP | MTProto прокси (диапазон для 10 пользователей) | Да (не нужен в режиме Port 443) |

- Статический IP-адрес или доменное имя
- Для HTTPS необходим домен, направленный A-записью на IP сервера
- **Стандартный режим:** диапазон портов MTProto прокси (по умолчанию 2443-2452) должен быть доступен извне; каждый пользователь на своём порту
- **Port 443 режим:** все пользователи подключаются через порт 443 (SNI routing); нестандартные порты не нужны
- Провайдер не должен блокировать используемые порты

## Технологии

- **Python 3.11** + **Flask 3.0** + **Gunicorn**
- **Docker SDK for Python** — управление контейнерами
- **mtg v2** — MTProto прокси-сервер (один инстанс на пользователя)
- **nginx** — обратный прокси
- **Tailwind CSS** — стилизация интерфейса
- **Let's Encrypt / Certbot** — SSL-сертификаты
