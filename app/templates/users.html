{% extends "base.html" %}
{% block title %}Users - MTProto Manager{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-2xl font-bold text-white">Users</h2>
        <p class="text-dark-300 text-sm mt-1">Manage proxy access keys</p>
    </div>
    <button onclick="document.getElementById('add-modal').classList.remove('hidden')"
        class="btn-primary text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:shadow-lg hover:shadow-indigo-500/25 transition-all flex items-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
        Add User
    </button>
</div>

{% if not users %}
<div class="card rounded-xl p-12 text-center">
    <svg class="w-16 h-16 text-dark-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    <h3 class="text-white font-semibold mb-2">No users yet</h3>
    <p class="text-dark-400 text-sm mb-4">Add your first user to generate a proxy access key</p>
    <button onclick="document.getElementById('add-modal').classList.remove('hidden')"
        class="btn-primary text-white px-4 py-2 rounded-lg text-sm font-medium">
        Add First User
    </button>
</div>
{% else %}
<div class="space-y-3">
    {% for user in users %}
    <div class="card rounded-xl p-5 {% if not user.enabled %}opacity-60{% endif %}">
        <div class="flex flex-col sm:flex-row sm:items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-2">
                    <h3 class="text-white font-semibold">{{ user.name }}</h3>
                    {% if user.enabled %}
                    <span class="px-2 py-0.5 bg-green-900/50 text-green-400 text-xs rounded-full border border-green-800">Active</span>
                    {% else %}
                    <span class="px-2 py-0.5 bg-red-900/50 text-red-400 text-xs rounded-full border border-red-800">Disabled</span>
                    {% endif %}
                    {% if user.fake_tls_domain and cfg.port_443_mode %}
                    <span class="px-2 py-0.5 bg-cyan-900/50 text-cyan-400 text-xs rounded-full border border-cyan-800">SNI: {{ user.fake_tls_domain }}</span>
                    {% endif %}
                    {% if user.port %}
                    <span class="px-2 py-0.5 bg-indigo-900/50 text-indigo-400 text-xs rounded-full border border-indigo-800">{% if cfg.port_443_mode %}Port: 443{% else %}Port: {{ user.port }}{% endif %}</span>
                    {% set ut = traffic_per_user.get(user.port) %}
                    {% if ut %}
                    {% set total = ut.rx_bytes + ut.tx_bytes %}
                    {% if total >= 1073741824 %}
                    <span class="px-2 py-0.5 bg-purple-900/50 text-purple-400 text-xs rounded-full border border-purple-800" title="Down: {{ '%.1f'|format(ut.rx_bytes / 1073741824) }} GB / Up: {{ '%.1f'|format(ut.tx_bytes / 1073741824) }} GB">Traffic: {{ '%.1f'|format(total / 1073741824) }} GB</span>
                    {% elif total >= 1048576 %}
                    <span class="px-2 py-0.5 bg-purple-900/50 text-purple-400 text-xs rounded-full border border-purple-800" title="Down: {{ '%.1f'|format(ut.rx_bytes / 1048576) }} MB / Up: {{ '%.1f'|format(ut.tx_bytes / 1048576) }} MB">Traffic: {{ '%.1f'|format(total / 1048576) }} MB</span>
                    {% elif total > 0 %}
                    <span class="px-2 py-0.5 bg-purple-900/50 text-purple-400 text-xs rounded-full border border-purple-800" title="Down: {{ '%.1f'|format(ut.rx_bytes / 1024) }} KB / Up: {{ '%.1f'|format(ut.tx_bytes / 1024) }} KB">Traffic: {{ '%.1f'|format(total / 1024) }} KB</span>
                    {% endif %}
                    {% if ut.throttled %}
                    <span class="px-2 py-0.5 bg-red-900/50 text-red-400 text-xs rounded-full border border-red-700">Throttled</span>
                    {% endif %}
                    {% endif %}
                    {% endif %}
                    {% if user.get("traffic_limit_gb", 0) > 0 %}
                    <span class="px-2 py-0.5 bg-yellow-900/50 text-yellow-400 text-xs rounded-full border border-yellow-800">Limit: {{ user.traffic_limit_gb }} GB</span>
                    {% endif %}
                    {% if user.get("throttle_speed_mbps", 0) > 0 %}
                    <span class="px-2 py-0.5 bg-orange-900/50 text-orange-400 text-xs rounded-full border border-orange-800">Speed: {{ user.throttle_speed_mbps }} Mbps</span>
                    {% endif %}
                </div>
                <div class="space-y-2">
                    <div>
                        <span class="text-dark-400 text-xs">Secret:</span>
                        <code class="text-dark-200 text-xs font-mono ml-1 bg-dark-700 px-2 py-0.5 rounded select-all break-all">{{ user.secret }}</code>
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <a href="{{ user.tme_link }}" target="_blank"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600/20 text-blue-400 text-xs rounded-lg border border-blue-800 hover:bg-blue-600/30 transition-all">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                            t.me
                        </a>
                        <button onclick="copyText('{{ user.tme_link }}', this)"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-dark-600 text-dark-200 text-xs rounded-lg border border-dark-500 hover:bg-dark-500 transition-all">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                            Copy
                        </button>
                        <button onclick="showQR({{ loop.index0 }}, '{{ user.name }}')"
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-dark-600 text-dark-200 text-xs rounded-lg border border-dark-500 hover:bg-dark-500 transition-all">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/></svg>
                            QR
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button type="button" title="Settings"
                    onclick="openUserSettings({{ loop.index0 }}, '{{ user.name }}', '{{ user.fake_tls_domain|default("", true) }}', {{ user.get('traffic_limit_gb', 0) }}, {{ user.get('throttle_speed_mbps', 0) }})"
                    class="p-2 rounded-lg bg-dark-600 text-dark-300 hover:bg-indigo-900/50 hover:text-indigo-400 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
                <form method="POST" action="{{ url_for('user_toggle', idx=loop.index0) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" title="{% if user.enabled %}Disable{% else %}Enable{% endif %}"
                        class="p-2 rounded-lg {% if user.enabled %}bg-green-900/30 text-green-400 hover:bg-green-900/50{% else %}bg-dark-600 text-dark-300 hover:bg-dark-500{% endif %} transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {% if user.enabled %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            {% else %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                            {% endif %}
                        </svg>
                    </button>
                </form>
                <form method="POST" action="{{ url_for('user_delete', idx=loop.index0) }}"
                    onsubmit="return confirm('Delete user {{ user.name }}?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" title="Delete"
                        class="p-2 rounded-lg bg-dark-600 text-dark-300 hover:bg-red-900/50 hover:text-red-400 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Add User Modal -->
<div id="add-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="card rounded-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold text-white mb-4">Add New User</h3>
        <form method="POST" action="{{ url_for('user_add') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-200 mb-1.5">User Name</label>
                <input type="text" name="name" required autofocus
                    class="w-full px-3.5 py-2.5 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                    placeholder="e.g. Phone, Friend, etc.">
            </div>
            <div class="flex gap-3 justify-end">
                <button type="button" onclick="document.getElementById('add-modal').classList.add('hidden')"
                    class="px-4 py-2.5 bg-dark-600 text-dark-200 rounded-lg text-sm font-medium hover:bg-dark-500 transition-all">
                    Cancel
                </button>
                <button type="submit"
                    class="btn-primary text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:shadow-lg hover:shadow-indigo-500/25 transition-all">
                    Add User
                </button>
            </div>
        </form>
    </div>
</div>

<!-- QR Modal -->
<div id="qr-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="card rounded-xl p-6 w-full max-w-sm mx-4 text-center">
        <h3 class="text-lg font-semibold text-white mb-4" id="qr-title">QR Code</h3>
        <div class="bg-white rounded-xl p-4 inline-block mb-4">
            <img id="qr-img" src="" class="w-48 h-48" alt="QR Code">
        </div>
        <p class="text-dark-400 text-xs mb-4">Scan with Telegram to connect</p>
        <button onclick="document.getElementById('qr-modal').classList.add('hidden')"
            class="px-4 py-2 bg-dark-600 text-dark-200 rounded-lg text-sm font-medium hover:bg-dark-500 transition-all">
            Close
        </button>
    </div>
</div>

<!-- User Settings Modal -->
<div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm" onclick="if(event.target===this)this.classList.add('hidden')">
    <div class="card rounded-xl p-6 w-full max-w-md mx-4">
        <h3 class="text-lg font-semibold text-white mb-4" id="settings-title">User Settings</h3>
        <form method="POST" id="settings-form" action="">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            {% if cfg.port_443_mode %}
            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-200 mb-1.5">SNI Domain</label>
                <select name="fake_tls_domain" id="settings-ftd"
                    class="w-full px-3.5 py-2.5 bg-dark-700 border border-dark-500 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                    {% for d in domain_pool %}
                    <option value="{{ d }}">{{ d }}{% if d in used_domains %} (in use){% endif %}</option>
                    {% endfor %}
                </select>
                <p class="text-dark-400 text-xs mt-1">Changing domain will regenerate the secret and restart the proxy</p>
            </div>
            {% endif %}

            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-200 mb-1.5">Traffic Limit (GB)</label>
                <input type="number" name="traffic_limit_gb" id="settings-limit" step="0.1" min="0"
                    class="w-full px-3.5 py-2.5 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                    placeholder="0 = use global default">
                <p class="text-dark-400 text-xs mt-1">0 = use global setting ({{ cfg.traffic_limit_gb or 'no limit' }}{% if cfg.traffic_limit_gb %} GB{% endif %})</p>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-dark-200 mb-1.5">Throttle Speed (Mbps)</label>
                <input type="number" name="throttle_speed_mbps" id="settings-speed" step="0.1" min="0"
                    class="w-full px-3.5 py-2.5 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-dark-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
                    placeholder="0 = use global default">
                <p class="text-dark-400 text-xs mt-1">0 = use global setting ({{ cfg.throttle_speed_mbps }} Mbps)</p>
            </div>

            <div class="flex gap-3 justify-end">
                <button type="button" onclick="document.getElementById('settings-modal').classList.add('hidden')"
                    class="px-4 py-2.5 bg-dark-600 text-dark-200 rounded-lg text-sm font-medium hover:bg-dark-500 transition-all">
                    Cancel
                </button>
                <button type="submit"
                    class="btn-primary text-white px-4 py-2.5 rounded-lg text-sm font-medium hover:shadow-lg hover:shadow-indigo-500/25 transition-all">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function openUserSettings(idx, name, ftd, limitGb, speedMbps) {
    document.getElementById('settings-title').textContent = name + ' â€” Settings';
    document.getElementById('settings-form').action = '/users/' + idx + '/settings';
    document.getElementById('settings-limit').value = limitGb || 0;
    document.getElementById('settings-speed').value = speedMbps || 0;
    var ftdSelect = document.getElementById('settings-ftd');
    if (ftdSelect && ftd) {
        ftdSelect.value = ftd;
    }
    document.getElementById('settings-modal').classList.remove('hidden');
}

function copyText(text, btn) {
    navigator.clipboard.writeText(text).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
        setTimeout(() => { btn.innerHTML = orig; }, 1500);
    });
}

function showQR(idx, name) {
    document.getElementById('qr-title').textContent = name + ' - QR Code';
    document.getElementById('qr-img').src = '/users/' + idx + '/qr?' + Date.now();
    document.getElementById('qr-modal').classList.remove('hidden');
}
</script>
{% endblock %}
